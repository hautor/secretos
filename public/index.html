<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mr. Chow's Hole</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">

  <!-- Open Graph / Twitter -->
  <meta property="og:title" content="Mr. Chow's Hole — Intercambia secretos anónimos" />
  <meta property="og:description" content="Cuenta o graba un secreto y recibe uno de otra persona. Sin registros. 100% anónimo." />
  <meta property="og:image" content="https://secretos-t3nu.onrender.com/favicon.svg" />
  <meta property="og:url" content="https://secretos-t3nu.onrender.com" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Mr. Chow's Hole — Intercambia secretos anónimos" />
  <meta name="twitter:description" content="Cuenta o graba un secreto y recibe uno de otra persona. Sin registros. 100% anónimo." />
  <meta name="twitter:image" content="https://secretos-t3nu.onrender.com/favicon.svg" />

  <style>
    /* Pulso suave al reproducir audio */
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.15); opacity: 0.8; }
    }
    .pulsing {
      animation: pulse 1.2s ease-in-out infinite;
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <main class="max-w-xl mx-auto p-6">
    <header class="mb-6 text-center">
      <div class="flex flex-col items-center gap-2">
        <!-- Logo minimalista -->
        <svg aria-hidden="true" width="72" height="72" viewBox="0 0 64 64" class="drop-shadow-sm">
          <defs>
            <radialGradient id="hole" cx="50%" cy="50%" r="60%">
              <stop offset="0%"  stop-color="#000"/>
              <stop offset="70%" stop-color="#000"/>
              <stop offset="100%" stop-color="#111"/>
            </radialGradient>
          </defs>
          <circle cx="32" cy="32" r="24" fill="url(#hole)"/>
          <ellipse cx="26" cy="26" rx="6" ry="3.5" fill="#fff" opacity="0.08"/>
        </svg>
        <h1 class="text-3xl font-bold tracking-tight">Mr. Chow's Hole</h1>
        <p class="text-slate-600 mt-1">Cuenta o escribe un secreto. A cambio, escucharás el de otra persona.</p>
      </div>

      <!-- Contador público -->
      <div class="mt-3 text-sm text-slate-600">
        Secretos intercambiados: <strong id="countExchanged">—</strong>
      </div>

      <!-- Botones compartir -->
      <div class="flex justify-center gap-3 mt-3">
        <button id="shareWhatsApp" class="px-3 py-1 rounded-lg bg-green-500 text-white text-sm hover:bg-green-600">WhatsApp</button>
        <button id="shareTwitter" class="px-3 py-1 rounded-lg bg-sky-500 text-white text-sm hover:bg-sky-600">X / Twitter</button>
        <button id="copyLink" class="px-3 py-1 rounded-lg bg-gray-300 text-sm hover:bg-gray-400">Copiar enlace</button>
      </div>
    </header>

    <section class="bg-white rounded-2xl shadow p-5 space-y-4">
      <div class="flex gap-2 justify-center">
        <button id="modeText" class="px-4 py-2 rounded-xl bg-slate-900 text-white">Texto</button>
        <button id="modeAudio" class="px-4 py-2 rounded-xl bg-slate-200">Audio</button>
      </div>

      <!-- Contadores -->
      <div class="flex flex-wrap items-center justify-center gap-3 text-sm text-slate-600">
        <span>Disponibles para ti: <strong id="countOther">—</strong></span>
        <span class="hidden sm:inline">•</span>
        <span>Total sin reclamar: <strong id="countTotal">—</strong></span>
        <button id="refreshStats" class="ml-2 px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200">
          Actualizar
        </button>
      </div>

      <!-- Texto -->
      <div id="textPane" class="space-y-3">
        <label class="block text-sm font-medium">Tu secreto (5–280 caracteres)</label>
        <textarea id="secretText" maxlength="280" rows="4" class="w-full rounded-xl border p-3" placeholder="Escribe aquí..."></textarea>
        <div class="flex justify-between items-center">
          <span id="charCount" class="text-xs text-slate-500">0/280</span>
          <button id="sendText" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">Enviar</button>
        </div>
      </div>

      <!-- Audio -->
      <div id="audioPane" class="space-y-3 hidden">
        <p class="text-sm text-slate-600">Graba tu secreto (máx. ~60s)</p>
        <div class="flex gap-2">
          <button id="recBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white">Grabar</button>
          <button id="stopBtn" class="px-4 py-2 rounded-xl bg-slate-200" disabled>Detener</button>
          <button id="sendAudio" class="px-4 py-2 rounded-xl bg-indigo-600 text-white" disabled>Enviar</button>
        </div>
        <audio id="preview" controls class="w-full hidden"></audio>
      </div>

      <div id="status" class="text-sm text-slate-600"></div>
    </section>

    <section class="mt-6 bg-white rounded-2xl shadow p-5">
      <h2 class="text-xl font-semibold mb-2">Secreto recibido</h2>
      <div id="result" class="text-slate-800"></div>

      <!-- Contenedor del icono + reproductor -->
      <div id="audioWrapper" class="flex items-center gap-2 mt-3 hidden">
        <svg id="audioIcon" xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-emerald-600 cursor-pointer hover:text-emerald-800 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M11 5L6 9H2v6h4l5 4V5zM15.54 8.46a5 5 0 010 7.07M19.07 4.93a10 10 0 010 14.14" />
        </svg>
        <audio id="player" controls class="w-full"></audio>
      </div>

      <div class="mt-3">
        <button id="tryFetch" class="px-3 py-2 rounded-xl bg-slate-200">Intentar conseguir uno ahora</button>
      </div>
    </section>

    <p class="text-xs text-slate-500 mt-4">No envíes datos personales ni contenido ilegal. Este prototipo aplica un filtro básico.</p>
  </main>

  <script>
    const shareURL = "https://secretos-t3nu.onrender.com";
    const shareText = "Cuenta o graba un secreto y recibe otro anónimo en Mr. Chow's Hole";
    document.getElementById("shareWhatsApp").onclick = () => window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(shareText + " " + shareURL)}`, "_blank");
    document.getElementById("shareTwitter").onclick = () => window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareURL)}`, "_blank");
    document.getElementById("copyLink").onclick = async () => {
      try { await navigator.clipboard.writeText(shareURL); alert("Enlace copiado"); }
      catch { alert("No se pudo copiar el enlace"); }
    };

    const modeTextBtn = document.getElementById('modeText');
    const modeAudioBtn = document.getElementById('modeAudio');
    const textPane = document.getElementById('textPane');
    const audioPane = document.getElementById('audioPane');

    const secretText = document.getElementById('secretText');
    const charCount = document.getElementById('charCount');
    const sendText = document.getElementById('sendText');

    const recBtn = document.getElementById('recBtn');
    const stopBtn = document.getElementById('stopBtn');
    const sendAudio = document.getElementById('sendAudio');
    const preview = document.getElementById('preview');

    const statusEl = document.getElementById('status');
    const result = document.getElementById('result');
    const player = document.getElementById('player');
    const tryFetch = document.getElementById('tryFetch');
    const audioWrapper = document.getElementById('audioWrapper');
    const audioIcon = document.getElementById('audioIcon');

    const countOther = document.getElementById('countOther');
    const countTotal = document.getElementById('countTotal');
    const countExchanged = document.getElementById('countExchanged');
    const refreshStatsBtn = document.getElementById('refreshStats');

    let mediaRecorder, chunks = [], blob;

    function setMode(mode) {
      if (mode === 'text') {
        textPane.classList.remove('hidden'); audioPane.classList.add('hidden');
        modeTextBtn.classList.add('bg-slate-900','text-white');
        modeAudioBtn.classList.remove('bg-slate-900','text-white'); modeAudioBtn.classList.add('bg-slate-200');
      } else {
        textPane.classList.add('hidden'); audioPane.classList.remove('hidden');
        modeAudioBtn.classList.add('bg-slate-900','text-white');
        modeTextBtn.classList.remove('bg-slate-900','text-white'); modeTextBtn.classList.add('bg-slate-200');
      }
    }
    modeTextBtn.onclick = () => setMode('text');
    modeAudioBtn.onclick = () => setMode('audio');

    secretText.addEventListener('input', () => { charCount.textContent = `${secretText.value.length}/280`; });
    function showStatus(msg) { statusEl.textContent = msg || ''; }

    async function loadStats() {
      try {
        const res = await fetch('/api/stats');
        if (!res.ok) throw new Error();
        const data = await res.json();
        countOther.textContent = data.available_for_you ?? 0;
        countTotal.textContent = data.available_total ?? 0;
        if (countExchanged) countExchanged.textContent = data.exchanged_total ?? 0;
        const hasForYou = Number(countOther.textContent) > 0;
        countOther.classList.toggle('text-emerald-600', hasForYou);
        countOther.classList.toggle('text-slate-600', !hasForYou);
      } catch {
        countOther.textContent = '—'; countTotal.textContent = '—';
        if (countExchanged) countExchanged.textContent = '—';
      }
    }
    refreshStatsBtn.onclick = loadStats;
    loadStats(); setInterval(loadStats, 10000);

    function displaySecret(payload) {
      if (!payload) return;
      result.innerHTML = ''; audioWrapper.classList.add('hidden');
      player.pause(); player.removeAttribute('src');
      if (payload.type === 'audio') { player.src = payload.url; audioWrapper.classList.remove('hidden'); }
      else if (payload.type === 'text') { const p = document.createElement('p'); p.textContent = payload.text; result.appendChild(p); }
    }

    audioIcon.onclick = () => { if (player.paused) player.play().catch(()=>{}); else player.pause(); };
    player.onplay = () => audioIcon.classList.add('pulsing');
    player.onpause = player.onended = () => audioIcon.classList.remove('pulsing');

    sendText.onclick = async () => {
      const text = (secretText.value || '').trim();
      showStatus('Enviando...');
      try {
        const res = await fetch('/api/secrets/text', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text }) });
        if (res.status === 204) { showStatus('Gracias por tu secreto.'); await loadStats(); return; }
        const data = await res.json(); displaySecret(data); showStatus('');
        secretText.value = ''; charCount.textContent = '0/280'; await loadStats();
      } catch { showStatus('Error enviando secreto.'); }
    };

    recBtn.onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        chunks = []; mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = () => { blob = new Blob(chunks, { type: 'audio/webm' }); preview.src = URL.createObjectURL(blob); preview.classList.remove('hidden'); sendAudio.disabled = false; };
        mediaRecorder.start(); recBtn.disabled = true; stopBtn.disabled = false; showStatus('Grabando...');
        setTimeout(() => { if (mediaRecorder?.state === 'recording') mediaRecorder.stop(); }, 60000);
      } catch { showStatus('No se pudo acceder al micrófono.'); }
    };
    stopBtn.onclick = () => { if (mediaRecorder?.state === 'recording') { mediaRecorder.stop(); recBtn.disabled = false; stopBtn.disabled = true; showStatus('Grabación detenida.'); } };
    sendAudio.onclick = async () => {
      if (!blob) return;
      showStatus('Enviando audio...'); const fd = new FormData(); fd.append('audio', blob, 'secret.webm');
      try {
        const res = await fetch('/api/secrets/audio', { method: 'POST', body: fd });
        if (res.status === 204) { showStatus('Gracias por tu secreto.'); preview.classList.add('hidden'); sendAudio.disabled = true; await loadStats(); return; }
        const data = await res.json(); displaySecret(data); showStatus(''); preview.classList.add('hidden'); sendAudio.disabled = true; await loadStats();
      } catch { showStatus('Error enviando audio.'); }
    };

    tryFetch.onclick = async () => {
      showStatus('Buscando secreto...');
      try {
        const res = await fetch('/api/secrets/one');
        if (res.status === 204) { showStatus('No hay disponible.'); await loadStats(); return; }
        const data = await res.json(); displaySecret(data); showStatus(''); await loadStats();
      } catch { showStatus('Error al buscar.'); }
    };
  </script>
</body>
</html>
